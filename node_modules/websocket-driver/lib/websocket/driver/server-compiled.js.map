{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server-compiled.js","sourcesContent":["'use strict';\n\nvar util       = require('util'),\n    HttpParser = require('../http_parser'),\n    Base       = require('./base'),\n    Draft75    = require('./draft75'),\n    Draft76    = require('./draft76'),\n    Hybi       = require('./hybi');\n\nvar Server = function(options) {\n  Base.call(this, null, null, options);\n  this._http = new HttpParser('request');\n};\nutil.inherits(Server, Base);\n\nvar instance = {\n  EVENTS: ['open', 'message', 'error', 'close'],\n\n  _bindEventListeners: function() {\n    this.messages.on('error', function() {});\n    this.on('error', function() {});\n  },\n\n  parse: function(chunk) {\n    if (this._delegate) return this._delegate.parse(chunk);\n\n    this._http.parse(chunk);\n    if (!this._http.isComplete()) return;\n\n    this.method  = this._http.method;\n    this.url     = this._http.url;\n    this.headers = this._http.headers;\n    this.body    = this._http.body;\n\n    var self = this;\n    this._delegate = Server.http(this, this._options);\n    this._delegate.messages = this.messages;\n    this._delegate.io = this.io;\n    this._open();\n\n    this.EVENTS.forEach(function(event) {\n      this._delegate.on(event, function(e) { self.emit(event, e) });\n    }, this);\n\n    this.protocol = this._delegate.protocol;\n    this.version  = this._delegate.version;\n\n    this.parse(this._http.body);\n    this.emit('connect', new Base.ConnectEvent());\n  },\n\n  _open: function() {\n    this.__queue.forEach(function(msg) {\n      this._delegate[msg[0]].apply(this._delegate, msg[1]);\n    }, this);\n    this.__queue = [];\n  }\n};\n\n['addExtension', 'setHeader', 'start', 'frame', 'text', 'binary', 'ping', 'close'].forEach(function(method) {\n  instance[method] = function() {\n    if (this._delegate) {\n      return this._delegate[method].apply(this._delegate, arguments);\n    } else {\n      this.__queue.push([method, arguments]);\n      return true;\n    }\n  };\n});\n\nfor (var key in instance)\n  Server.prototype[key] = instance[key];\n\nServer.isSecureRequest = function(request) {\n  if (request.connection && request.connection.authorized !== undefined) return true;\n  if (request.socket && request.socket.secure) return true;\n\n  var headers = request.headers;\n  if (!headers) return false;\n  if (headers['https'] === 'on') return true;\n  if (headers['x-forwarded-ssl'] === 'on') return true;\n  if (headers['x-forwarded-scheme'] === 'https') return true;\n  if (headers['x-forwarded-proto'] === 'https') return true;\n\n  return false;\n};\n\nServer.determineUrl = function(request) {\n  var scheme = this.isSecureRequest(request) ? 'wss:' : 'ws:';\n  return scheme + '//' + request.headers.host + request.url;\n};\n\nServer.http = function(request, options) {\n  options = options || {};\n  if (options.requireMasking === undefined) options.requireMasking = true;\n\n  var headers = request.headers,\n      url     = this.determineUrl(request);\n\n  if (headers['sec-websocket-version'])\n    return new Hybi(request, url, options);\n  else if (headers['sec-websocket-key1'])\n    return new Draft76(request, url, options);\n  else\n    return new Draft75(request, url, options);\n};\n\nmodule.exports = Server;\n"]}