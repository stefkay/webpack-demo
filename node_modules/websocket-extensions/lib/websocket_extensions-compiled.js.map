{"version":3,"sources":["websocket_extensions.js"],"names":[],"mappings":"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","file":"websocket_extensions-compiled.js","sourcesContent":["'use strict';\n\nvar Parser   = require('./parser'),\n    Pipeline = require('./pipeline');\n\nvar Extensions = function() {\n  this._rsv1 = this._rsv2 = this._rsv3 = null;\n\n  this._byName   = {};\n  this._inOrder  = [];\n  this._sessions = [];\n  this._index    = {}\n};\n\nExtensions.MESSAGE_OPCODES = [1, 2];\n\nvar instance = {\n  add: function(ext) {\n    if (typeof ext.name !== 'string') throw new TypeError('extension.name must be a string');\n    if (ext.type !== 'permessage') throw new TypeError('extension.type must be \"permessage\"');\n\n    if (typeof ext.rsv1 !== 'boolean') throw new TypeError('extension.rsv1 must be true or false');\n    if (typeof ext.rsv2 !== 'boolean') throw new TypeError('extension.rsv2 must be true or false');\n    if (typeof ext.rsv3 !== 'boolean') throw new TypeError('extension.rsv3 must be true or false');\n\n    if (this._byName.hasOwnProperty(ext.name))\n      throw new TypeError('An extension with name \"' + ext.name + '\" is already registered');\n\n    this._byName[ext.name] = ext;\n    this._inOrder.push(ext);\n  },\n\n  generateOffer: function() {\n    var sessions = [],\n        offer    = [],\n        index    = {};\n\n    this._inOrder.forEach(function(ext) {\n      var session = ext.createClientSession();\n      if (!session) return;\n\n      var record = [ext, session];\n      sessions.push(record);\n      index[ext.name] = record;\n\n      var offers = session.generateOffer();\n      offers = offers ? [].concat(offers) : [];\n\n      offers.forEach(function(off) {\n        offer.push(Parser.serializeParams(ext.name, off));\n      }, this);\n    }, this);\n\n    this._sessions = sessions;\n    this._index    = index;\n\n    return offer.length > 0 ? offer.join(', ') : null;\n  },\n\n  activate: function(header) {\n    var responses = Parser.parseHeader(header),\n        sessions  = [];\n\n    responses.eachOffer(function(name, params) {\n      var record = this._index[name];\n\n      if (!record)\n        throw new Error('Server sent an extension response for unknown extension \"' + name + '\"');\n\n      var ext      = record[0],\n          session  = record[1],\n          reserved = this._reserved(ext);\n\n      if (reserved)\n        throw new Error('Server sent two extension responses that use the RSV' +\n                        reserved[0] + ' bit: \"' +\n                        reserved[1] + '\" and \"' + ext.name + '\"');\n\n      if (session.activate(params) !== true)\n        throw new Error('Server sent unacceptable extension parameters: ' +\n                        Parser.serializeParams(name, params));\n\n      this._reserve(ext);\n      sessions.push(record);\n    }, this);\n\n    this._sessions = sessions;\n    this._pipeline = new Pipeline(sessions);\n  },\n\n  generateResponse: function(header) {\n    var offers   = Parser.parseHeader(header),\n        sessions = [],\n        response = [];\n\n    this._inOrder.forEach(function(ext) {\n      var offer = offers.byName(ext.name);\n      if (offer.length === 0 || this._reserved(ext)) return;\n\n      var session = ext.createServerSession(offer);\n      if (!session) return;\n\n      this._reserve(ext);\n      sessions.push([ext, session]);\n      response.push(Parser.serializeParams(ext.name, session.generateResponse()));\n    }, this);\n\n    this._sessions = sessions;\n    this._pipeline = new Pipeline(sessions);\n\n    return response.length > 0 ? response.join(', ') : null;\n  },\n\n  validFrameRsv: function(frame) {\n    var allowed = {rsv1: false, rsv2: false, rsv3: false},\n        ext;\n\n    if (Extensions.MESSAGE_OPCODES.indexOf(frame.opcode) >= 0) {\n      for (var i = 0, n = this._sessions.length; i < n; i++) {\n        ext = this._sessions[i][0];\n        allowed.rsv1 = allowed.rsv1 || ext.rsv1;\n        allowed.rsv2 = allowed.rsv2 || ext.rsv2;\n        allowed.rsv3 = allowed.rsv3 || ext.rsv3;\n      }\n    }\n\n    return (allowed.rsv1 || !frame.rsv1) &&\n           (allowed.rsv2 || !frame.rsv2) &&\n           (allowed.rsv3 || !frame.rsv3);\n  },\n\n  processIncomingMessage: function(message, callback, context) {\n    this._pipeline.processIncomingMessage(message, callback, context);\n  },\n\n  processOutgoingMessage: function(message, callback, context) {\n    this._pipeline.processOutgoingMessage(message, callback, context);\n  },\n\n  close: function(callback, context) {\n    if (!this._pipeline) return callback.call(context);\n    this._pipeline.close(callback, context);\n  },\n\n  _reserve: function(ext) {\n    this._rsv1 = this._rsv1 || (ext.rsv1 && ext.name);\n    this._rsv2 = this._rsv2 || (ext.rsv2 && ext.name);\n    this._rsv3 = this._rsv3 || (ext.rsv3 && ext.name);\n  },\n\n  _reserved: function(ext) {\n    if (this._rsv1 && ext.rsv1) return [1, this._rsv1];\n    if (this._rsv2 && ext.rsv2) return [2, this._rsv2];\n    if (this._rsv3 && ext.rsv3) return [3, this._rsv3];\n    return false;\n  }\n};\n\nfor (var key in instance)\n  Extensions.prototype[key] = instance[key];\n\nmodule.exports = Extensions;\n"]}