{"version":3,"sources":["trans-jsonp.js"],"names":[],"mappings":"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","file":"trans-jsonp-compiled.js","sourcesContent":["// Generated by CoffeeScript 1.9.3\n(function() {\n  var JsonpReceiver, transport,\n    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n    hasProp = {}.hasOwnProperty;\n\n  transport = require('./transport');\n\n  JsonpReceiver = (function(superClass) {\n    extend(JsonpReceiver, superClass);\n\n    JsonpReceiver.prototype.protocol = \"jsonp-polling\";\n\n    JsonpReceiver.prototype.max_response_size = 1;\n\n    function JsonpReceiver(req, res, options, callback1) {\n      this.callback = callback1;\n      JsonpReceiver.__super__.constructor.call(this, req, res, options);\n    }\n\n    JsonpReceiver.prototype.doSendFrame = function(payload) {\n      return JsonpReceiver.__super__.doSendFrame.call(this, \"/**/\" + this.callback + \"(\" + JSON.stringify(payload) + \");\\r\\n\");\n    };\n\n    return JsonpReceiver;\n\n  })(transport.ResponseReceiver);\n\n  exports.app = {\n    jsonp: function(req, res, _, next_filter) {\n      var callback;\n      if (!('c' in req.query || 'callback' in req.query)) {\n        throw {\n          status: 500,\n          message: '\"callback\" parameter required'\n        };\n      }\n      callback = 'c' in req.query ? req.query['c'] : req.query['callback'];\n      if (/[^a-zA-Z0-9-_.]/.test(callback) || callback.length > 32) {\n        throw {\n          status: 500,\n          message: 'invalid \"callback\" parameter'\n        };\n      }\n      res.setHeader('X-Content-Type-Options', 'nosniff');\n      res.setHeader('Content-Type', 'application/javascript; charset=UTF-8');\n      res.writeHead(200);\n      transport.register(req, this, new JsonpReceiver(req, res, this.options, callback));\n      return true;\n    },\n    jsonp_send: function(req, res, query) {\n      var d, i, jsonp, len, message, x;\n      if (!query) {\n        throw {\n          status: 500,\n          message: 'Payload expected.'\n        };\n      }\n      if (typeof query === 'string') {\n        try {\n          d = JSON.parse(query);\n        } catch (_error) {\n          x = _error;\n          throw {\n            status: 500,\n            message: 'Broken JSON encoding.'\n          };\n        }\n      } else {\n        d = query.d;\n      }\n      if (typeof d === 'string' && d) {\n        try {\n          d = JSON.parse(d);\n        } catch (_error) {\n          x = _error;\n          throw {\n            status: 500,\n            message: 'Broken JSON encoding.'\n          };\n        }\n      }\n      if (!d || d.__proto__.constructor !== Array) {\n        throw {\n          status: 500,\n          message: 'Payload expected.'\n        };\n      }\n      jsonp = transport.Session.bySessionId(req.session);\n      if (jsonp === null) {\n        throw {\n          status: 404\n        };\n      }\n      for (i = 0, len = d.length; i < len; i++) {\n        message = d[i];\n        jsonp.didMessage(message);\n      }\n      res.setHeader('Content-Length', '2');\n      res.setHeader('Content-Type', 'text/plain; charset=UTF-8');\n      res.writeHead(200);\n      res.end('ok');\n      return true;\n    }\n  };\n\n}).call(this);\n"]}