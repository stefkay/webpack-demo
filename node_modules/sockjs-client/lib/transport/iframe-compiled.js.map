{"version":3,"sources":["iframe.js"],"names":[],"mappings":"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","file":"iframe-compiled.js","sourcesContent":["'use strict';\n\n// Few cool transports do work only for same-origin. In order to make\n// them work cross-domain we shall use iframe, served from the\n// remote domain. New browsers have capabilities to communicate with\n// cross domain iframe using postMessage(). In IE it was implemented\n// from IE 8+, but of course, IE got some details wrong:\n//    http://msdn.microsoft.com/en-us/library/cc197015(v=VS.85).aspx\n//    http://stevesouders.com/misc/test-postmessage.php\n\nvar inherits = require('inherits')\n  , JSON3 = require('json3')\n  , EventEmitter = require('events').EventEmitter\n  , version = require('../version')\n  , urlUtils = require('../utils/url')\n  , iframeUtils = require('../utils/iframe')\n  , eventUtils = require('../utils/event')\n  , random = require('../utils/random')\n  ;\n\nvar debug = function() {};\nif (process.env.NODE_ENV !== 'production') {\n  debug = require('debug')('sockjs-client:transport:iframe');\n}\n\nfunction IframeTransport(transport, transUrl, baseUrl) {\n  if (!IframeTransport.enabled()) {\n    throw new Error('Transport created when disabled');\n  }\n  EventEmitter.call(this);\n\n  var self = this;\n  this.origin = urlUtils.getOrigin(baseUrl);\n  this.baseUrl = baseUrl;\n  this.transUrl = transUrl;\n  this.transport = transport;\n  this.windowId = random.string(8);\n\n  var iframeUrl = urlUtils.addPath(baseUrl, '/iframe.html') + '#' + this.windowId;\n  debug(transport, transUrl, iframeUrl);\n\n  this.iframeObj = iframeUtils.createIframe(iframeUrl, function(r) {\n    debug('err callback');\n    self.emit('close', 1006, 'Unable to load an iframe (' + r + ')');\n    self.close();\n  });\n\n  this.onmessageCallback = this._message.bind(this);\n  eventUtils.attachEvent('message', this.onmessageCallback);\n}\n\ninherits(IframeTransport, EventEmitter);\n\nIframeTransport.prototype.close = function() {\n  debug('close');\n  this.removeAllListeners();\n  if (this.iframeObj) {\n    eventUtils.detachEvent('message', this.onmessageCallback);\n    try {\n      // When the iframe is not loaded, IE raises an exception\n      // on 'contentWindow'.\n      this.postMessage('c');\n    } catch (x) {\n      // intentionally empty\n    }\n    this.iframeObj.cleanup();\n    this.iframeObj = null;\n    this.onmessageCallback = this.iframeObj = null;\n  }\n};\n\nIframeTransport.prototype._message = function(e) {\n  debug('message', e.data);\n  if (!urlUtils.isOriginEqual(e.origin, this.origin)) {\n    debug('not same origin', e.origin, this.origin);\n    return;\n  }\n\n  var iframeMessage;\n  try {\n    iframeMessage = JSON3.parse(e.data);\n  } catch (ignored) {\n    debug('bad json', e.data);\n    return;\n  }\n\n  if (iframeMessage.windowId !== this.windowId) {\n    debug('mismatched window id', iframeMessage.windowId, this.windowId);\n    return;\n  }\n\n  switch (iframeMessage.type) {\n  case 's':\n    this.iframeObj.loaded();\n    // window global dependency\n    this.postMessage('s', JSON3.stringify([\n      version\n    , this.transport\n    , this.transUrl\n    , this.baseUrl\n    ]));\n    break;\n  case 't':\n    this.emit('message', iframeMessage.data);\n    break;\n  case 'c':\n    var cdata;\n    try {\n      cdata = JSON3.parse(iframeMessage.data);\n    } catch (ignored) {\n      debug('bad json', iframeMessage.data);\n      return;\n    }\n    this.emit('close', cdata[0], cdata[1]);\n    this.close();\n    break;\n  }\n};\n\nIframeTransport.prototype.postMessage = function(type, data) {\n  debug('postMessage', type, data);\n  this.iframeObj.post(JSON3.stringify({\n    windowId: this.windowId\n  , type: type\n  , data: data || ''\n  }), this.origin);\n};\n\nIframeTransport.prototype.send = function(message) {\n  debug('send', message);\n  this.postMessage('m', message);\n};\n\nIframeTransport.enabled = function() {\n  return iframeUtils.iframeEnabled;\n};\n\nIframeTransport.transportName = 'iframe';\nIframeTransport.roundTrips = 2;\n\nmodule.exports = IframeTransport;\n"]}